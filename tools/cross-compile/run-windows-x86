#!/usr/bin/env bash

################################################################################
# Copyright 2019-present Jay B. <j@1791.io>                                    #
#                                                                              #
# Licensed under the Apache License, Version 2.0 (the "License");              #
# you may not use this file except in compliance with the License.             #
# You may obtain a copy of the License at                                      #
#                                                                              #
#     http://www.apache.org/licenses/LICENSE-2.0                               #
#                                                                              #
# Unless required by applicable law or agreed to in writing, software          #
# distributed under the License is distributed on an "AS IS" BASIS,            #
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.     #
# See the License for the specific language governing permissions and          #
# limitations under the License.                                               #
################################################################################

SCRIPT_PATH=${BASH_SOURCE[0]}

SCRIPT_DIRECTORY=$(dirname "$SCRIPT_PATH")
SCRIPT_DIRECTORY="$(cd $SCRIPT_DIRECTORY >/dev/null 2>&1 && pwd)"

PROJECT_DIRECTORY=$SCRIPT_DIRECTORY/../..
PROJECT_DIRECTORY="$(cd $PROJECT_DIRECTORY >/dev/null 2>&1 && pwd)"
CONTAINER_PROJECT_DIRECTORY=/home/project

PROJECT_VERSION=$(cat $PROJECT_DIRECTORY/VERSION)

BUILD_TARGET_ARCHITECTURE="x86"
BUILD_TARGET_OS="windows"

# PROJECT_NATIVE_SOURCES=$PROJECT_DIRECTORY/src/main/native/carlie
CONTAINER_PROJECT_NATIVE_SOURCES=$CONTAINER_PROJECT_DIRECTORY/src/main/native/carlie

BUILD_JDK_PATH=$PROJECT_DIRECTORY/resources/jdk/$BUILD_TARGET_OS/$BUILD_TARGET_ARCHITECTURE
CONTAINER_BUILD_JDK_PATH=/home/jdk
CONTAINER_BUILD_JAVA_HOME=$CONTAINER_BUILD_JDK_PATH
CONTAINER_BUILD_JDK_INCLUDE_DIRECTORIES="$CONTAINER_BUILD_JAVA_HOME/include/win32;$CONTAINER_BUILD_JAVA_HOME/include"

BUILD_JVM_NATIVE_PATH=$PROJECT_DIRECTORY/resources/native/$BUILD_TARGET_OS/$BUILD_TARGET_ARCHITECTURE
CONTAINER_BUILD_JVM_NATIVE_PATH=/home/jvm/native
CONTAINER_BUILD_JVM_NATIVE_INCLUDE_DIRECTORY=$CONTAINER_BUILD_JVM_NATIVE_PATH/include
CONTAINER_BUILD_JVM_NATIVE_LIBRARIES_DIRECTORY=$CONTAINER_BUILD_JVM_NATIVE_PATH/lib

CMAKE_BUILD_PATH=$PROJECT_DIRECTORY/cmake-build/$BUILD_TARGET_OS/$BUILD_TARGET_ARCHITECTURE
CONTAINER_CMAKE_BUILD_PATH=/home/cmake-build

JVM_PACKAGE_NATIVE_LIBRARIES=$PROJECT_DIRECTORY/src/main/resources/native-libraries/$BUILD_TARGET_OS/$BUILD_TARGET_ARCHITECTURE
CONTAINER_JVM_PACKAGE_NATIVE_LIBRARIES=/home/jvm/package-native-libraries

DOCKER_RUN_ARGUMENTS=""
DOCKER_RUN_ARGUMENTS="$DOCKER_RUN_ARGUMENTS --env CARLIE_BUILD_JAVA_HOME=$CONTAINER_BUILD_JAVA_HOME"
DOCKER_RUN_ARGUMENTS="$DOCKER_RUN_ARGUMENTS --env CARLIE_BUILD_JDK_INCLUDE_DIRECTORIES=$CONTAINER_BUILD_JDK_INCLUDE_DIRECTORIES"
DOCKER_RUN_ARGUMENTS="$DOCKER_RUN_ARGUMENTS --env CARLIE_BUILD_JDK_PATH=$CONTAINER_BUILD_JDK_PATH"
DOCKER_RUN_ARGUMENTS="$DOCKER_RUN_ARGUMENTS --env CARLIE_BUILD_JVM_NATIVE_INCLUDE_DIRECTORY=$CONTAINER_BUILD_JVM_NATIVE_INCLUDE_DIRECTORY"
DOCKER_RUN_ARGUMENTS="$DOCKER_RUN_ARGUMENTS --env CARLIE_BUILD_JVM_NATIVE_LIBRARIES_DIRECTORY=$CONTAINER_BUILD_JVM_NATIVE_LIBRARIES_DIRECTORY"
DOCKER_RUN_ARGUMENTS="$DOCKER_RUN_ARGUMENTS --env CARLIE_BUILD_JVM_NATIVE_PATH=$CONTAINER_BUILD_JVM_NATIVE_PATH"
DOCKER_RUN_ARGUMENTS="$DOCKER_RUN_ARGUMENTS --env CARLIE_BUILD_TARGET_ARCHITECTURE=$BUILD_TARGET_ARCHITECTURE"
DOCKER_RUN_ARGUMENTS="$DOCKER_RUN_ARGUMENTS --env CARLIE_BUILD_TARGET_OS=$BUILD_TARGET_OS"
DOCKER_RUN_ARGUMENTS="$DOCKER_RUN_ARGUMENTS --env CARLIE_CMAKE_BUILD_PATH=$CONTAINER_CMAKE_BUILD_PATH"
DOCKER_RUN_ARGUMENTS="$DOCKER_RUN_ARGUMENTS --env CARLIE_JVM_PACKAGE_NATIVE_LIBRARIES=$CONTAINER_JVM_PACKAGE_NATIVE_LIBRARIES"
DOCKER_RUN_ARGUMENTS="$DOCKER_RUN_ARGUMENTS --env CARLIE_PROJECT_DIRECTORY=$CONTAINER_PROJECT_DIRECTORY"
DOCKER_RUN_ARGUMENTS="$DOCKER_RUN_ARGUMENTS --env CARLIE_PROJECT_NATIVE_SOURCES=$CONTAINER_PROJECT_NATIVE_SOURCES"
DOCKER_RUN_ARGUMENTS="$DOCKER_RUN_ARGUMENTS --env CARLIE_PROJECT_VERSION=$PROJECT_VERSION"
DOCKER_RUN_ARGUMENTS="$DOCKER_RUN_ARGUMENTS --volume $PROJECT_DIRECTORY:$CONTAINER_PROJECT_DIRECTORY"
DOCKER_RUN_ARGUMENTS="$DOCKER_RUN_ARGUMENTS --volume $BUILD_JDK_PATH:$CONTAINER_BUILD_JDK_PATH"
DOCKER_RUN_ARGUMENTS="$DOCKER_RUN_ARGUMENTS --volume $BUILD_JVM_NATIVE_PATH:$CONTAINER_BUILD_JVM_NATIVE_PATH"
DOCKER_RUN_ARGUMENTS="$DOCKER_RUN_ARGUMENTS --volume $CMAKE_BUILD_PATH:$CONTAINER_CMAKE_BUILD_PATH"
DOCKER_RUN_ARGUMENTS="$DOCKER_RUN_ARGUMENTS --volume $JVM_PACKAGE_NATIVE_LIBRARIES:$CONTAINER_JVM_PACKAGE_NATIVE_LIBRARIES"

$SCRIPT_DIRECTORY/dockcross-windows-x86-static \
  --args "$DOCKER_RUN_ARGUMENTS" \
  --image "dockcross/windows-static-x86@sha256:6bb573265563d877597e2dd434b51dbcf3dadc743f67972120eadcfe98b26c90" \
  bash -c "$*"
